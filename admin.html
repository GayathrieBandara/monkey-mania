<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/admin.css">
</head>

<body>
    <h1>Admin Panel</h1>
    <button id="logoutBtn" style="background:#ff6b6b; color:white;">Logout</button>

    <h2>Registered Users</h2>
    <table id="usersTable">
        <tr>
            <th>ID (UID)</th>
            <th>Username</th>
            <th>Email</th>
            <th>Action</th>
        </tr>
        <!-- Users inserted here -->
    </table>

    <h2>Leaderboard (Top 20)</h2>
    <table id="leaderboardTable">
        <tr>
            <th>Rank</th>
            <th>Username</th>
            <th>Score</th>
        </tr>
        <!-- Scores inserted here -->
    </table>

    <button class="clear-btn" id="clearScoresBtn">Clear Leaderboard</button>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, getDocs, doc, getDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Auth Check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists() || !userDoc.data().isAdmin) {
                    alert("Access Denied: You are not an admin.");
                    window.location.href = "home.html";
                    return;
                }
                // Load Data
                loadUsers();
                loadLeaderboard();
            } catch (e) {
                console.error("Auth verify error", e);
                window.location.href = "home.html";
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

        async function loadUsers() {
            const table = document.getElementById('usersTable');
            // Clear existing rows except header
            while (table.rows.length > 1) { table.deleteRow(1); }

            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const row = table.insertRow();
                    row.insertCell(0).innerText = docSnap.id;
                    row.insertCell(1).innerText = data.username || "N/A";
                    row.insertCell(2).innerText = data.email || "N/A";

                    const actionCell = row.insertCell(3);
                    const btn = document.createElement('button');
                    btn.className = 'delete-btn';
                    btn.innerText = 'Delete';
                    btn.onclick = () => deleteUser(docSnap.id);
                    actionCell.appendChild(btn);
                });
            } catch (e) {
                console.error("Error loading users:", e);
            }
        }

        async function deleteUser(uid) {
            if (!confirm("Are you sure you want to delete this user? This removes their record from the database.")) return;
            try {
                await deleteDoc(doc(db, "users", uid));
                alert("User deleted from database.");
                loadUsers();
            } catch (e) {
                console.error("Error deleting user:", e);
                alert("Error deleting user: " + e.message);
            }
        }

        async function loadLeaderboard() {
            const table = document.getElementById('leaderboardTable');
            while (table.rows.length > 1) { table.deleteRow(1); }

            try {
                const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                let rank = 1;
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const row = table.insertRow();
                    row.insertCell(0).innerText = rank++;
                    row.insertCell(1).innerText = data.username || "Unknown";
                    row.insertCell(2).innerText = data.score;
                });
            } catch (e) {
                console.error("Error loading leaderboard:", e);
            }
        }

        document.getElementById('clearScoresBtn').addEventListener('click', async () => {
            if (!confirm("Are you sure you want to clear ALL scores displayed here?")) return;
            try {
                const q = query(collection(db, "scores"), limit(50)); // Limit to prevent massive reads/deletes in one go for now
                const querySnapshot = await getDocs(q);
                const promises = [];
                querySnapshot.forEach((docSnap) => {
                    promises.push(deleteDoc(docSnap.ref));
                });
                await Promise.all(promises);
                alert("Leaderboard cleared.");
                loadLeaderboard();
            } catch (e) {
                console.error("Error clearing scores:", e);
                alert("Failed to clear scores.");
            }
        });

    </script>
</body>

</html>